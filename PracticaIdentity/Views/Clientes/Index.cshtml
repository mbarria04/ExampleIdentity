@{
    ViewData["Title"] = "Clientes";
}

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Clientes</h5>
      @*   <input type="text" id="txtCedula" class="form-control w-25" placeholder="Ingrese cédula" />
        <button id="btnConsultar" class="btn btn-primary">Consultar</button> *@

        <button class="btn btn-success mb-3" data-toggle="modal" data-target="#modalAgregarCliente">
            Agregar Cliente
        </button>
    </div>
    <div class="card-body">
        <table id="tablaClientes" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Nombre</th>
                    <th>Apellido</th>
                    <th>Email</th>
                    <th>Telefono</th>
                    <th>Fecha Registro</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Modal Agregar / Editar Cliente -->
<div class="modal fade" id="modalAgregarCliente" tabindex="-1" role="dialog" aria-labelledby="modalAgregarClienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalAgregarClienteLabel">Agregar Cliente</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formAgregarCliente">
                    <input type="hidden" id="IdCliente" />
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="Nombre">Nombre</label>
                            <input type="text" class="form-control" id="Nombre" name="Nombre"  required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="Apellido">Apellido</label>
                            <input type="text" class="form-control" id="Apellido" name="Apellido" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="Email">Email</label>
                            <input type="email" class="form-control" id="Email" name="Email">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="Telefono">Teléfono</label>
                            <input type="text" class="form-control" id="Telefono" name="Telefono">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="FechaRegistro">Fecha Registro</label>
                            <input type="date" class="form-control" id="FechaRegistro" name="FechaRegistro" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                        <button type="submit" id="btnGuardarCliente" class="btn btn-primary">
                            Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

          $("#formAgregarCliente").validate({

            rules: {
                Nombre: {
                    required: true,
                    minlength: 2,
                    maxlength: 30
                },
                Apellido: {
                    required: true,
                    minlength: 2,
                    maxlength: 30
                },
                Email: {
                    email: true,
                    maxlength: 100
                },
                Telefono: {
                    digits: true,
                    maxlength: 15
                }
            },

            messages: {
                Nombre: {
                    required: "Ingrese el nombre",
                    minlength: "Mínimo 2 caracteres",
                    maxlength: "Máximo 30 caracteres"
                },
                Apellido: {
                    required: "Ingrese el apellido",
                    minlength: "Mínimo 2 caracteres",
                    maxlength: "Máximo 30 caracteres"
                },
                Email: {
                    email: "Email inválido"
                },
                Telefono: {
                    digits: "Solo números"
                }
            },

            errorElement: "span",
            errorClass: "text-danger",

            errorPlacement: function (error, element) {
                error.insertAfter(element);
            },

            submitHandler: function () {
                guardarCliente();
            }
        });




            // ================= DataTable =================
            var table = $('#tablaClientes').DataTable({
                ajax: {
                    url: "/Clientes/ObtenerClientes",
                    type: "GET",
                    dataSrc: ""
                },
                columns: [
                    { data: 'id' },
                    { data: 'nombre' },
                    { data: 'apellido' },
                    { data: 'email' },
                    { data: 'telefono' },
                    {
                        data: 'fechaRegistro',
                        render: function (data) {
                            return new Date(data).toLocaleDateString("es-PA");
                        }
                    },
                    {
                        data: null,
                        render: function (data) {
                            return `<button class="btn btn-warning btn-sm btnEditar" data-id="${data.id}">Editar</button>`;
                        }
                    }
                ]
            });

            // ================ Consultar por cédula ================
            $("#btnConsultar").click(function () {
                var cedula = $("#txtCedula").val();
                $.ajax({
                    url: "/Clientes/Consultar",
                    type: "GET",
                    data: { cedula: cedula },
                    success: function (data) {
                        table.clear().rows.add(data).draw();
                    },
                    error: function (xhr) {
                        alert("Error: " + xhr.status + " - " + xhr.responseText);
                    }
                });
            });

            $(document).on('click', '.btnEditar', function () {
             var id = $(this).data('id');

              $.ajax({
                url: "/Clientes/ObtenerPorId",
                type: "GET",
                data: { id: id },
                success: function (cliente) {
                    $("#IdCliente").val(cliente.id);
                    $("#Nombre").val(cliente.nombre);
                    $("#Apellido").val(cliente.apellido);
                    $("#Email").val(cliente.email);
                    $("#Telefono").val(cliente.telefono);
                    $("#FechaRegistro").val(cliente.fechaRegistro.split('T')[0]);

                    $("#modalAgregarClienteLabel").text("Editar Cliente");
                    $("#modalAgregarCliente").modal("show");
                     },
                   error: function (xhr) {
                       alert("Error al obtener el cliente: " + xhr.status + " - " + xhr.responseText);
                   }
               });
             });

            // ================== Guardar Cliente (Agregar o Editar) ==================
          function guardarCliente() {
                var cliente = {
                    Id: $("#IdCliente").val(),
                    Nombre: $("#Nombre").val(),
                    Apellido: $("#Apellido").val(),
                    Email: $("#Email").val(),
                    Telefono: $("#Telefono").val(),
                    FechaRegistro: $("#FechaRegistro").val()
                };

                const esEditar = !!cliente.Id;
                var url = cliente.Id ? "/Clientes/Editar" : "/Clientes/Agregar";
                var type = cliente.Id ? "PUT" : "POST";

        // Si es AGREGAR, quitar Id del payload
            if (!esEditar) {
                delete cliente.Id;
                // (Opcional) si FechaRegistro la define el servidor, también quítala:
                // delete cliente.FechaRegistro;
            }

                console.log(JSON.stringify(cliente));

                $.ajax({
                    url: url,
                    type: type,
                    contentType: "application/json",
                    data: JSON.stringify(cliente),
                    success: function () {
                        $("#modalAgregarCliente").modal("hide");
                        $("#formAgregarCliente")[0].reset();
                        $("#IdCliente").val("");
                        $("#modalAgregarClienteLabel").text("Agregar Cliente");
                        table.ajax.reload(null, false);
                        if (esEditar) {
                              showAlert("Cliente actualizado correctamente ✅", "success");
                         } else {
                             showAlert("Cliente agregado correctamente ✅", "success");
                          }
                    },
                    error: function (xhr) {
                        // alert("Error: " + xhr.status + " - " + xhr.responseText);
                        showAlert("Error al guardar el cliente ❌", "error");
                    }
                });
            }

            // ================== Limpiar modal al abrir para agregar ==================
            $('[data-target="#modalAgregarCliente"]').click(function () {
                $("#formAgregarCliente")[0].reset();
                $("#IdCliente").val("");
                $("#modalAgregarClienteLabel").text("Agregar Cliente");
            });

        });
    </script>
}
